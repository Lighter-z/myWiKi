<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="MingZhao">
    
    <link rel="shortcut icon" href="../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>LWIP - MingZhao</title>
    <link href="../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../js/jquery-3.2.1.min.js"></script>
    <script src="../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "LWIP", url: "#_top", children: [
              {title: "3. RAW\u7f16\u7a0b\u63a5\u53e3", url: "#3-raw" },
              {title: "1. LWIP\u6570\u636e\u5305\u548c\u7f51\u7edc\u63a5\u53e3\u7ba1\u7406", url: "#1-lwip" },
              {title: "3. RAW\u7f16\u7a0b\u63a5\u53e3", url: "#3-raw_1" },
              {title: "4. NETCONN\u7f16\u7a0b\u65b9\u5f0f", url: "#4-netconn" },
          ]},
        ];

    </script>
    <script src="../../js/base.js"></script>
      <script src="https://unpkg.com/mermaid@7.1.0/dist/mermaid.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.7/raphael.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sequence-diagrams/1.0.6/sequence-diagram-min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.6.5/flowchart.min.js"></script>
      <script src="../../js/umlconvert.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    

    <h1 id="lwip">LWIP<a class="headerlink" href="#lwip" title="Permanent link">#</a></h1>
<p><img alt="00-lwip-raw-api" src="../00-picture/00-lwip-raw-api.png" /></p>
<p>socket需要用到内存拷贝</p>
<p>netconn不需要用到内存拷贝</p>
<p>前两者使用都需要使用操作系统</p>
<p>raw编程方式可以不使用操作系统，主要使用的是回调函数</p>
<h2 id="3-raw">3. RAW编程接口<a class="headerlink" href="#3-raw" title="Permanent link">#</a></h2>
<h2 id="1-lwip">1. LWIP数据包和网络接口管理<a class="headerlink" href="#1-lwip" title="Permanent link">#</a></h2>
<h3 id="11-lwip">1.1 LWIP数据包管理<a class="headerlink" href="#11-lwip" title="Permanent link">#</a></h3>
<p>LWIP使用pbuf结构体描述协议栈使用中的数据包，pbuf结构体在pbuf.h中定义</p>
<h3 id="12-lwip">1.2 LWIP网络接口管理<a class="headerlink" href="#12-lwip" title="Permanent link">#</a></h3>
<p>netif结构体实现对网络接口的描述，在netif.h中定义</p>
<p>netif_add() 网卡注册函数  把一个netif结构体添加在netif_list中</p>
<h2 id="3-raw_1">3. RAW编程接口<a class="headerlink" href="#3-raw_1" title="Permanent link">#</a></h2>
<ul>
<li>LWIP的RAW API编程方式是基于回调机制的，初始化应用时，需要将内核中不同的事件注册相应的回调函数。</li>
</ul>
<h3 id="31-udp">3.1 UDP简介<a class="headerlink" href="#31-udp" title="Permanent link">#</a></h3>
<ol>
<li>UDP常用的功能函数</li>
</ol>
<table>
<thead>
<tr>
<th>RAW API函数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>udp_new</td>
<td>新建udp的pcb控制块</td>
</tr>
<tr>
<td>udp_remove</td>
<td>将一个pcb控制块从链表中删除，并释放该控制块的内存</td>
</tr>
<tr>
<td>udp_bind</td>
<td>给udp的pcb控制块绑定一个本地ip地址与端口号</td>
</tr>
<tr>
<td>udp_connect</td>
<td>连接指定ip地址的指定端口（设置pcb控制块的remote_ip与remote_port）</td>
</tr>
<tr>
<td>udp_disconnect</td>
<td>断开连接</td>
</tr>
<tr>
<td>udp_send</td>
<td>通过pcb控制块发送消息</td>
</tr>
<tr>
<td>udp_recv</td>
<td>注册回调函数，接收数据时调用</td>
</tr>
</tbody>
</table>
<ol>
<li>RAW API编程接口中与UDP相关的函数关系</li>
</ol>
<p><img alt="00-lwip-raw-udp" src="../00-picture/00-lwip-raw-udp.png" /></p>
<ol>
<li>连接流程</li>
</ol>
<p>3.1 初始化</p>
<ul>
<li>lwipdev.remoteip[]设置ip</li>
<li>udp_new 创建udp的pcb控制块</li>
<li>IP4_ADDR ：将lwipdev.remoteip[]的四字节地址设置为ip地址</li>
<li>udp_connect：upd客户端连接到指定IP地址和端口号的服务器</li>
<li>udp_bind：绑定本地的IP地址与端口号</li>
<li>udp_recv：注册接收回调函数</li>
<li>调用LWIP轮询任务，正点原子：lwip_periodic_handle()。</li>
<li>lwip_pkt_handle()</li>
</ul>
<p>3.2 发送函数</p>
<ul>
<li>udp_send</li>
</ul>
<p>3.3 接收到数据后需要调用</p>
<ul>
<li>
<p>ethernetif_input()  。</p>
</li>
<li>
<blockquote>
<p>之前在添加网卡(netif_add)时，注册的函数</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code> &gt; 作用：从网路缓冲区中读取数据包，并发给LWIP处理
</code></pre></div>
</td></tr></table>

</blockquote>
</li>
</ul>
<p>3.3 关闭连接</p>
<ul>
<li>
<p>udp_disconnect()断开udp连接</p>
</li>
<li>
<p>udp_remove() 将pcb控制块从链表中删除，释放内存</p>
</li>
<li>创建udp时若失败，也需要将其关闭，删除。</li>
</ul>
<h3 id="32-tcp">3.2 TCP简介<a class="headerlink" href="#32-tcp" title="Permanent link">#</a></h3>
<ol>
<li>TCP的RAW API常用函数</li>
</ol>
<table>
  <tr>
    <th>函数分组</th>
    <th>API函数</th>
    <th>函数功能描述</th>
  </tr>
  <tr>
    <td rowspan="6">TCP建立连接</td>
    <td>tcp_new()</td>
    <td>创建一个TCP的PCB控制块</td>
  </tr>
  <tr>
    <td>tcp_bind()</td>
    <td>为TCP的PCB控制块绑定一个本地的IP地址和端口号</td>
  </tr>
  <tr>
    <td>tcp_listen()</td>
    <td>监听TCP的PCB</td>
  </tr>
  <tr>
    <td>tcp_accept()</td>
    <td>控制块accept字段注册的回调函数，监听到连接时调用</td>
  </tr>
  <tr>
    <td>tcp_accepted()</td>
    <td>通知LIWIP协议栈，一个TCP已经被连接</td>
  </tr>
  <tr>
      <td>tcp_conect()</td>
      <td>连接远程主机</td>
  </tr>
  <tr>
      <td rowspan="3">发送TCP数据</td>
      <td>tcp_write()</td>
      <td>构建一个报文，并放在控制块的发送缓冲队列中</td>
  </tr>
  <tr>
      <td>tcp_sent()</td>
      <td>控制块sent字段注册的回调函数，数据发送成功后被回调</td>
  </tr>
  <tr>
      <td>tcp_output()</td>
      <td>将发送缓冲队列中的数据发送出去</td>
  </tr>
  <tr>
      <td rowspan="2">接收TCP数据</td>
      <td>tcp_recv()</td>
      <td>控制块recv字段注册的回调函数，当接收到新数据时被调用</td>
  </tr>
  <tr>
      <td>tcp_recved()</td>
      <td>当程序处理完数据后一定要调用此函数，通知内核更新接收窗口</td>
  </tr>
  <tr>
      <td>轮询函数</td>
      <td>tcp_poll()</td>
      <td>控制块poll字段注册的回调函数，该函数周期性调用</td>
  </tr>
  <tr>
      <td rowspan="3">关闭和中止连接</td>
      <td>tcp_close()</td>
      <td>关闭TCP连接</td>
  </tr>
  <tr>
      <td>tcp_err()</td>
      <td>控制块err字段注册的回调函数，遇到错误时被调用</td>
  </tr>
  <tr>
      <td>tcp_abort()</td>
      <td>中断TCP连接</td>
  </tr>
</table>

<ol>
<li>RAW API编程接口中与TCP相关的函数关系</li>
</ol>
<p><img alt="00-lwip-raw-tcp" src="../00-picture/00-lwip-raw-tcp.png" /></p>
<ol>
<li>
<p>TCP状态</p>
</li>
<li>
<p>LWIP中在tcp.h中通过枚举类型定义出了TCP的11种状态：tcp_state</p>
</li>
<li>说明</li>
<li><img alt="00-lwip-tcp-state" src="../00-picture/00-lwip-tcp-state.png" /></li>
<li>状态图</li>
</ol>
<p><img alt="00-lwip-tcp-state-picture" src="../00-picture/00-lwip-tcp-state-picture.png" /></p>
<ol>
<li>连接流程</li>
</ol>
<p>3.1 初始化</p>
<ul>
<li>tcp_new()；创建TCP控制块</li>
<li>IP4_ADDR ()；设置远端IP地址</li>
<li>tcp_connect()；连接到远端IP地址的指定端口号上，连接成功后回调注册的connected参数所对应的函数<ul>
<li>建立连接后，回调函数中设置相应函数</li>
<li>tcp_arg()：</li>
<li>tcp_recv()：</li>
<li>tcp_err()：</li>
<li>tcp_sent()：</li>
<li>tcp_poll()：</li>
</ul>
</li>
<li>调用LWIP轮询任务，正点原子：lwip_periodic_handle()。</li>
<li>lwip_pkt_handle()</li>
</ul>
<h2 id="4-netconn">4. NETCONN编程方式<a class="headerlink" href="#4-netconn" title="Permanent link">#</a></h2>
<h3 id="41">4.1 简介<a class="headerlink" href="#41" title="Permanent link">#</a></h3>
<p><img alt="00-lwip-netconn" src="../00-picture/00-lwip-netconn-netbuf.png" /></p>
<p><img alt="00-lwip-netconn-netbuf-api -01" src="../00-picture/00-lwip-netconn-netbuf-api%20-01.png" /></p>
<p><img alt="00-lwip-netconn-struct" src="../00-picture/00-lwip-netconn-struct.png" /></p>
<p><img alt="00-lwip-netconn-api-01" src="../00-picture/00-lwip-netconn-api-01.png" /></p>
<p>netconn_send()函数用于udp连接上发送数据</p>
<p>netconn_write()函数用于tcp连接上发送数据</p>
<p>recv函数是阻塞的，设置超时时间后，便不会阻塞线程</p>
<p>udp</p>
<p>10ms不会丢包</p>
<p>5ms丢包</p>
<p><img alt="00-lwip-netconn-code0" src="../00-picture/00-lwip-netconn-code0.png" /></p>
<p>想要速度更快，把这个遍历拷贝编程以太网转串口，直接写到串口寄存器，串口打印，避免程序中的延时</p>
<p>实际应用时  发送与接收各自创建一个线程任务</p>

  <br>
    

    <br>
</div>

<footer class="container-fluid wm-page-content">
      <p>
        <a href="https://github.com/Lighter-z/myWiKi/edit/master/docs/嵌入式/02-LWIP.md"><i class="fa fa-github"></i>
Edit on GitHub</a>
      </p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>